#!/usr/bin/ash

CRYPTMOUNTS="$1"

reboot() { echo b > /proc/sysrq-trigger; }

# Start udev from initramfs
/usr/lib/systemd/systemd-udevd --daemon --resolve-names=never

# Suspend crypt devices
while IFS=$'\t' read -r mtpt name; do
    cryptsetup luksSuspend "$name"
done < "$CRYPTMOUNTS"

# Suspend the system
echo mem > /sys/power/state

# Resume root device only
cryptsetup luksResume "$(awk -F"\t" '/\/\t/{ print $2 }' "$CRYPTMOUNTS")" || reboot

# Stop udev from initramfs, as the real daemon from rootfs will be restarted
udevadm control --exit
